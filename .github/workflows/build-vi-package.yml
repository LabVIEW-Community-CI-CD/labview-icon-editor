name: Build VI Package

on:
  pull_request:
    branches: [main, develop, release/*, hotfix/*]
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [main, develop, release/*, hotfix/*]
  workflow_dispatch:

jobs:
  build-vi-package:
    runs-on: [self-hosted, iconeditor]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get Build Revision
        id: get_revision
        shell: pwsh
        run: |
          $COUNTER_FILE = "$env:GITHUB_WORKSPACE/.github/buildCounter.txt"
          if (-Not (Test-Path $COUNTER_FILE)) {
            "1" | Out-File $COUNTER_FILE
          }
          $build_revision = Get-Content $COUNTER_FILE
          $new_build_revision = [int]$build_revision + 1
          $new_build_revision | Out-File $COUNTER_FILE
          echo "build_revision=$new_build_revision" >> $env:GITHUB_OUTPUT

      - name: Build the icon editor VI package
        shell: pwsh
        
        # <--- Define environment variables for versioning here
        #      You can hardcode some (Major, Minor, Patch) or increment them
        env:
          VERSION_MAJOR: 1
          VERSION_MINOR: 0
          VERSION_PATCH: 0
          # Use the build counter as the Build portion
          VERSION_BUILD: ${{ steps.get_revision.outputs.build_revision }}
          # Use the Git commit SHA as the "Commit" parameter
          VERSION_COMMIT: ${{ github.sha }}

        run: |
          $repoRoot      = $env:GITHUB_WORKSPACE
          $scriptsFolder = Join-Path $repoRoot 'pipeline/scripts'

          # Now pass these env variables to your Build.ps1 script
          .\pipeline\scripts\Build.ps1 `
            -RelativePath        $repoRoot `
            -AbsolutePathScripts $scriptsFolder `
            -Major               $env:VERSION_MAJOR `
            -Minor               $env:VERSION_MINOR `
            -Patch               $env:VERSION_PATCH `
            -Build               $env:VERSION_BUILD `
            -Commit              $env:VERSION_COMMIT

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: vi-package
          path: 'builds/VI Package'
