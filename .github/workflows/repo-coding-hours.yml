name: Repository Coding Hours

on:
  schedule:
    - cron: '0 0 * * 1'
  workflow_dispatch:
    inputs:
      window_start:
        description: 'Optional start date YYYY-MM-DD'
        required: false

permissions:
  contents: write

jobs:
  repo-report:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v4
        with:
          go-version: '1.24'

      - name: Install git-hours v0.1.2
        run: |
          git clone --depth 1 --branch v0.1.2 https://github.com/trinhminhtriet/git-hours.git git-hours-src
          sed -i 's/go 1.24.1/go 1.24/' git-hours-src/go.mod
          (cd git-hours-src && go install .)

      - name: Run repo coding hours
        env:
          WINDOW_START: ${{ inputs.window_start }}
        run: |
          curl -Ls https://raw.githubusercontent.com/ni/labview-icon-editor/main/scripts/repo_coding_hours.py -o repo_coding_hours.py
          python3 repo_coding_hours.py

      - name: Commit JSON report
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name  "git-hours bot"
          git config --global user.email "bot@github.com"
          git add reports/git-hours-*.json
          git commit -m "chore(metrics): update git-hours $(date +%F)" || echo "No changes"
          git push
