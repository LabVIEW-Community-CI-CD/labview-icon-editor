name: Test missing‑in‑project action (Windows)
on: [workflow_dispatch]

jobs:
  test-action:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
        with: { fetch-depth: 0 }

      - name: Create dummy project + VI
        shell: pwsh
        run: |
          # lv_icon.lvproj at repo root
          "<Project/>" | Out-File "$Env:GITHUB_WORKSPACE\lv_icon.lvproj" -Encoding ASCII

          # Ensure action folder & dummy VI exist
          $actionDir = Join-Path $Env:GITHUB_WORKSPACE '.github\actions\missing-in-project'
          New-Item -ItemType Directory -Path $actionDir -Force | Out-Null
          "<VI/>" | Out-File (Join-Path $actionDir 'MissinInProjectCLI.vi') -Encoding ASCII

      - name: Stub g‑cli
        shell: pwsh
        run: |
          $stub = '@echo off
echo {"Passed": true, "MissingFiles": ""}'
          $stubPath = "$Env:GITHUB_WORKSPACE\g-cli.cmd"
          Set-Content -LiteralPath $stubPath -Value $stub -Encoding ASCII
          $Env:PATH = "$Env:GITHUB_WORKSPACE;$Env:PATH"

      - name: Run composite action
        id: mip
        uses: ./.github/actions/missing-in-project
        with:
          lv-ver: 2021
          arch: 64
          # project-path omitted => repo root

      - name: Show outputs
        shell: pwsh
        run: |
          Write-Host "passed:        ${{ steps.mip.outputs.passed }}"
          Write-Host "missing-files: ${{ steps.mip.outputs['missing-files'] }}"
