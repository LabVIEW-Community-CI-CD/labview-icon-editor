# --------------------------------------------------------------------------
#  Coding‚Äëhours report  ‚Äì¬†full workflow
# --------------------------------------------------------------------------
name: Coding‚Äëhours report

on:
  # weekly cron + manual trigger
  schedule:
    - cron: '0 0 * * 1'           # Monday¬†00:00¬†UTC
  workflow_dispatch:
    inputs:
      window_start:
        description: 'Analyse commits since¬†YYYY‚ÄëMM‚ÄëDD (optional)'
        required: false
      window_end:
        description: 'Analyse commits up to¬†YYYY‚ÄëMM‚ÄëDD (optional)'
        required: false

# --------------------------------------------------------------------------
#  Global settings
# --------------------------------------------------------------------------
concurrency:
  group: coding-hours-${{ github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: write
  actions: write        # needed for artefact DELETE
  id-token: write

env:
  GO_VERSION: '1.24'
  GITHOURS_VERSION: 'v0.1.2'

jobs:
  report:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
    # --------------------------------------------------------------------
    # 1Ô∏è‚É£  Repository checkout (full history for git‚Äëhours)
    # --------------------------------------------------------------------
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # --------------------------------------------------------------------
    # 2Ô∏è‚É£  Go toolchain + module cache
    # --------------------------------------------------------------------
    - uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true

    # --------------------------------------------------------------------
    # 3Ô∏è‚É£  Cache compiled git‚Äëhours binary
    # --------------------------------------------------------------------
    - name: Cache git‚Äëhours
      id: cache-githours
      uses: actions/cache@v4
      with:
        path: ~/go/bin/git-hours
        key: git-hours-${{ env.GO_VERSION }}-${{ env.GITHOURS_VERSION }}

    - name: Install git‚Äëhours (patched go.mod)
      if: steps.cache-githours.outputs.cache-hit != 'true'
      run: |
        git clone --depth 1 --branch $GITHOURS_VERSION https://github.com/trinhminhtriet/git-hours.git /tmp/git-hours
        sed -i 's/go 1\.24\.1/go 1.24/' /tmp/git-hours/go.mod
        (cd /tmp/git-hours && go install .)

    # --------------------------------------------------------------------
    # 4Ô∏è‚É£  Compute reporting window
    # --------------------------------------------------------------------
    - name: Compute date window
      id: dates
      run: |
        since="${{ github.event.inputs.window_start }}"
        until="${{ github.event.inputs.window_end }}"
        [[ -z "$since" ]] && since=$(date -u -d "last monday" +%F)
        [[ -z "$until" ]] && until=$(date -u +%F)
        echo "since=$since" >> "$GITHUB_OUTPUT"
        echo "until=$until" >> "$GITHUB_OUTPUT"

    # --------------------------------------------------------------------
    # 5Ô∏è‚É£  Generate raw git‚Äëhours.txt report
    # --------------------------------------------------------------------
    - name: Generate git‚Äëhours report
      run: |
        git-hours -since "${{ steps.dates.outputs.since }}" \
                  -until "${{ steps.dates.outputs.until }}" > git-hours.txt

    - name: Add raw report to summary
      run: |
        {
          echo "## ‚è± Coding‚Äëhours report"
          echo "_${{ steps.dates.outputs.since }} ‚Üí ${{ steps.dates.outputs.until }}_"
          echo ''
          echo '```text'
          cat git-hours.txt
          echo '```'
        } >> "$GITHUB_STEP_SUMMARY"

    # --------------------------------------------------------------------
    # 6Ô∏è‚É£  Upload raw report  (delete stale first to avoid 409)
    # --------------------------------------------------------------------
    - name: Delete stale git‚Äëhours artefact
      if: always()
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        ART="git-hours-${{ github.run_id }}"
        ids=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts \
              --jq ".artifacts[] | select(.name==\"$ART\") | .id")
        for id in $ids; do
          echo "Deleting artefact id=$id ‚Üí $ART"
          gh api --method DELETE repos/${{ github.repository }}/actions/artifacts/$id
        done

    - uses: actions/upload-artifact@v4
      with:
        name: git-hours-${{ github.run_id }}
        path: git-hours.txt
        retention-days: 30

    # --------------------------------------------------------------------
    # 7Ô∏è‚É£  Python¬†+¬†visual graphs (bar + stacked ISO‚Äëweek trend)
    # --------------------------------------------------------------------
    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install plotting libraries
      run: pip install --disable-pip-version-check pandas matplotlib requests

    - name: Build comparison graphs
      id: make-graphs
      env:
        GH_TOKEN: ${{ secrets.GH_PAT || github.token }}   # needs read:org
        ORG_NAME: ni
      run: |
        python - <<'PY'
        import base64, io, json, os, re, hashlib, requests, pathlib, datetime as dt
        import pandas as pd, matplotlib.pyplot as plt, collections

        RAW = pathlib.Path('git-hours.txt').read_text()

        # -------- parse git-hours output --------
        def parse(raw):
            try:
                data = json.loads(raw)
                return [(k, v['hours']) for k, v in data.items() if k.lower() not in ('total',)]
            except json.JSONDecodeError:
                pat = re.compile(r'^\s*(.*?)\s+(\d+(?:\.\d+)?)\s*h', re.I)
                return [(m.group(1).strip(), float(m.group(2)))
                        for m in map(pat.match, raw.splitlines()) if m]

        rows = parse(RAW)
        if not rows:
            print('::warning::No author/hour rows parsed'); exit(0)
        df_now = pd.DataFrame(rows, columns=['author', 'hours'])

        # -------- anonymise non‚ÄëNI contributors --------
        ORG   = os.getenv('ORG_NAME', 'ni')
        TOKEN = os.getenv('GH_TOKEN')
        HEAD  = {'Authorization': f'Bearer {TOKEN}'} if TOKEN else {}
        def member(user):
            return requests.get(f'https://api.github.com/orgs/{ORG}/members/{user}', headers=HEAD).status_code == 204
        mask = lambda name: f'Contributor_{hashlib.sha1(name.encode()).hexdigest()[:6]}'
        mapping = {a: (a if member(a.split("<")[0].strip()) else mask(a)) for a in df_now['author']}
        df_now['label'] = df_now['author'].map(mapping)

        # -------- bar chart (current window) --------
        df_now.sort_values('hours', inplace=True)
        fig1, ax1 = plt.subplots(figsize=(6, max(2, .35*len(df_now))))
        ax1.barh(df_now['label'], df_now['hours'])
        ax1.set_xlabel('Hours'); ax1.set_title('Hours per contributor')
        plt.tight_layout()

        # -------- stacked ISO‚Äëweek trend (last¬†8) --------
        def wk(date_str):
            iso = dt.date.fromisoformat(date_str).isocalendar()
            return f"{iso.year}-W{iso.week:02d}"

        def parse_file(fp):
            return {mapping.get(a, mask(a)): h for a, h in parse(fp.read_text())}

        hist = collections.defaultdict(lambda: collections.Counter())
        rpt_dir = pathlib.Path('reports')
        if rpt_dir.exists():
            for f in rpt_dir.glob('git-hours-*_to_*.txt'):
                end = f.stem.split('_to_')[-1]
                hist[wk(end)].update(parse_file(f))

        this_week = wk('${{ steps.dates.outputs.until }}')
        hist[this_week].update(df_now.set_index('label')['hours'].to_dict())

        weeks = sorted(hist.keys())[-8:]
        fig2 = None
        if weeks:
            pivot = pd.DataFrame([{**{'week': w}, **hist[w]} for w in weeks]).fillna(0)
            pivot.set_index('week', inplace=True)
            fig2, ax2 = plt.subplots(figsize=(6,3))
            labels = pivot.columns
            ax2.stackplot(pivot.index, *[pivot[c] for c in labels], labels=labels)
            ax2.legend(fontsize=6, loc='upper left', bbox_to_anchor=(1,1))
            ax2.set_ylabel('Hours')
            ax2.set_title('Weekly coding‚Äëhours (last¬†8¬†ISO weeks)')
            plt.xticks(rotation=45, ha='right'); plt.tight_layout()

        # -------- embed PNGs in job summary --------
        def to_b64(fig):
            buf = io.BytesIO(); fig.savefig(buf, format='png', dpi=140)
            return base64.b64encode(buf.getvalue()).decode()

        summ = pathlib.Path(os.environ['GITHUB_STEP_SUMMARY'])
        with summ.open('a') as s:
            s.write('## üìä Coding‚Äëhours visual summary\n')
            s.write(f'<img alt="bar"   src="data:image/png;base64,{to_b64(fig1)}"/>\n\n')
            if fig2:
                s.write(f'<img alt="trend" src="data:image/png;base64,{to_b64(fig2)}"/>\n')

        # -------- persist anonymisation map --------
        json_path = f'anonym-map-${{ github.run_id }}.json'
        json.dump(mapping, open(json_path, 'w'), indent=2)

        # expose as step output (GITHUB_OUTPUT)
        with open(os.getenv("GITHUB_OUTPUT"), "a") as fh:
            fh.write(f"json={json_path}\n")
        PY

    # --------------------------------------------------------------------
    # 8Ô∏è‚É£  Upload anonymisation map  (delete stale first)
    # --------------------------------------------------------------------
    - name: Delete stale anonymisation map
      if: always()
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        ART="anonymisation-map-${{ github.run_id }}"
        ids=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts \
              --jq ".artifacts[] | select(.name==\"$ART\") | .id")
        for id in $ids; do
          echo "Deleting artefact id=$id ‚Üí $ART"
          gh api --method DELETE repos/${{ github.repository }}/actions/artifacts/$id
        done

    - uses: actions/upload-artifact@v4
      with:
        name: anonymisation-map-${{ github.run_id }}
        path: ${{ steps.make-graphs.outputs.json }}
        retention-days: 90

    # --------------------------------------------------------------------
    # 9Ô∏è‚É£  (Optional) commit reports to metrics branch
    # --------------------------------------------------------------------
    - name: Commit to metrics branch
      if: github.ref_name == 'main'
      env:
        GH_TOKEN: ${{ secrets.GH_PAT }}  # PAT with repo write
      run: |
        if [ -z "$GH_TOKEN" ]; then
          echo "GH_PAT secret not set¬†‚Äî skipping metrics commit"
          exit 0
        fi
        git config --global user.name  "git‚Äëhours bot"
        git config --global user.email "bot@github.com"
        git fetch origin metrics || true
        git switch -C metrics origin/metrics || git switch -C metrics
        mkdir -p reports
        cp git-hours.txt "reports/git-hours-${{ steps.dates.outputs.since }}_to_${{ steps.dates.outputs.until }}.txt"
        git add reports
        git commit -m "chore(metrics): coding hours ${{ steps.dates.outputs.since }}‚Üí${{ steps.dates.outputs.until }}" || echo "No changes"
        git push "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}" HEAD:metrics
